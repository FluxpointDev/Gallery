@page "/admin"
@page "/upload"
@using Gallery.Database
@using ImageMagick
@using Gallery.Data
@using System.IO
@using Radzen
@attribute [Authorize]

@if (DB.GalleryUsers[Session.State.User.GetId()].upload.enabled)
{
    <RadzenTabs SelectedIndex="tabIndex">
        <Tabs>
            <RadzenTabsItem Text="Main">
                <div class="section">
                    <h3><span class="iconify" data-icon="mdi:database" data-inline="false" style="color: #fff;"></span> Database</h3>
                    <div class="section-list">
                        <div class="mat-layout-grid">
                            <div class="mat-layout-grid-inner">
                                <div class="mat-layout-grid-cell">
                                    <h5>Images: @DB.Images.Count</h5>
                                </div>
                                <div class="mat-layout-grid-cell">
                                    <h5>Albums: @DB.Albums.Count</h5>
                                </div>
                                <div class="mat-layout-grid-cell">
                                    <h5>Tags: @DB.Tags.Count</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <AuthorizeView Roles="owner">
                        <br />
                        <div class="section-list">
                            <RadzenButton Click=@(() => ReloadAction("tags")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("images")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("albums")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("metadata")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("users")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("api")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click=@(() => ReloadAction("waifu")) Text="Reload Tags" ButtonStyle="ButtonStyle.Light" />
                        </div>
                    </AuthorizeView>
                </div>
                <div class="section">
                    <h3><span class="iconify" data-icon="mdi:image-multiple" data-inline="false" style="color: #fff;"></span> Images</h3>
                    <div class="section-list">
                        <div class="section-item section-color-add" @onclick="@(() => GoTo(1))">
                            <h5>Upload</h5>
                            <span class="iconify" data-icon="mdi:cloud-upload" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-edit" @onclick="@(() => GoTo(2))">
                            <h5>Manage</h5>
                            <span class="iconify" data-icon="mdi:image-edit" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-delete" @onclick="@(() => GoTo(3))">
                            <h5>Delete</h5>
                            <span class="iconify" data-icon="mdi:image-remove" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-misc" @onclick="@TestClick">
                            <h5>Regen Thumbnails</h5>
                        </div>
                        <div class="section-item section-color-misc" @onclick="@CheckImages">
                            <h5>Check Images</h5>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3><span class="iconify" data-icon="mdi:folder-multiple-image" data-inline="false" style="color: #fff;"></span> Albums</h3>
                    <div class="section-list">
                        <div class="section-item section-color-add" @onclick="@(() => GoTo(4))">
                            <h5>Create</h5>
                            <span class="iconify" data-icon="mdi:folder-plus" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-edit" @onclick="@(() => GoTo(5))">
                            <h5>Manage</h5>
                            <span class="iconify" data-icon="mdi:folder-edit" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-delete" @onclick="@(() => GoTo(6))">
                            <h5>Delete</h5>
                            <span class="iconify" data-icon="mdi:folder-remove" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-misc" @onclick="@MigrateTags">
                            <h5>Migrate Tags</h5>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3><span class="iconify" data-icon="mdi:label-multiple" data-inline="false" style="color: #fff;"></span> Tags</h3>
                    <div class="section-list">
                        <div class="section-item section-color-add" @onclick="@(() => GoTo(7))">
                            <h5>Create</h5>
                            <span class="iconify" data-icon="mdi:tag-plus" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-edit" @onclick="@(() => GoTo(8))">
                            <h5>Manage</h5>
                            <span class="iconify" data-icon="mdi:tag-text" data-inline="false" style="color: #fff;"></span>
                        </div>
                        <div class="section-item section-color-delete" @onclick="@(() => GoTo(9))">
                            <h5>Delete</h5>
                            <span class="iconify" data-icon="mdi:tag-remove" data-inline="false" style="color: #fff;"></span>
                        </div>
                    </div>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Upload Image">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Image Upload</h2>
                </div>
                <UploadSection></UploadSection>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Manage Images">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Manage Images</h2>
                </div>
                <AuthorizeView Roles="owner">
                    <ImagesManageSection></ImagesManageSection>
                </AuthorizeView>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Delete Images">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Image Delete</h2>
                </div>
                <RadzenTextBox Value="@Image" Name="ID" />
                <button @onclick="@DeleteImage">Delete image</button>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Create Album">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Album Create</h2>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Manage Albums">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Album Manage</h2>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Delete Albums">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Album Delete</h2>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Create Tag">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Create Tag</h2>
                </div>
                <AuthorizeView Roles="owner">
                    <RadzenTextBox Value="@NewTag" Name="ID" />
                    <button @onclick="@AddTag">Add Tag</button>
                </AuthorizeView>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Manage Tags">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Tags Manage</h2>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Delete Tags">
                <div class="section-header">
                    <div class="section-back" @onclick="@(() => GoTo(0))">
                        <span class="iconify" data-icon="mdi:keyboard-backspace" data-inline="false" style="color: #fff;"></span>
                    </div>
                    <h2>Delete Tag</h2>
                </div>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
}

<style>
    .mdc-tab-bar {
        display: none;
    }

    .section {
        background-color: #303336;
        padding: 6px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .section-list {
        padding-left: 16px;
    }

    .section h3 {
        padding-left: 8px;
        margin-bottom: 10px;
    }

    .section-item {
        cursor: pointer;
        width: 110px;
        height: 110px;
        border-radius: 16px;
        background-color: #33383c;
        display: inline-block;
        text-align: center;
        margin-right: 5px;
    }

        .section-item h5 {
            margin-top: 26px;
        }

    .section-color-misc {
        padding-top: 12px !important;
    }

        .section-color-misc h5 {
            margin-top: 26px;
            padding-left: 8px;
            padding-right: 8px;
        }

    .section-item .iconify {
        width: 30px;
        height: 30px;
        vertical-align: middle;
    }

    .section .mdc-button {
        background-color: #1b6ec2;
    }

        .section .mdc-button:hover {
            background-color: #1861ac;
        }

    .section-color-add {
        background-color: #239f55;
    }

        .section-color-add:hover {
            background-color: #1e8a4a;
        }

    .section-color-edit {
        background-color: #d5a838;
    }

        .section-color-edit:hover {
            background-color: #c99c2a;
        }

    .section-color-delete {
        background-color: #c03636;
    }

        .section-color-delete:hover {
            background-color: #ac3030;
        }

    .section-color-misc {
        background-color: #3f6791;
    }

        .section-color-misc:hover {
            background-color: #375a7f;
        }

    .section-back {
        cursor: pointer;
        width: 50px;
        height: 50px;
        border-radius: 16px;
        background-color: #1b6ec2;
        display: inline-block;
        text-align: center;
        margin-right: 15px;
        margin-bottom: 10px;
    }

        .section-back:hover {
            background-color: #1861ac;
        }

        .section-back .iconify {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-top: 10px;
        }

    .section-header {
        margin-bottom: 15px;
    }

        .section-header h2 {
            vertical-align: middle;
            display: inline;
            padding-top: 10px;
        }
</style>






@code {
    public string Image = "";
    public string NewTag = "";

    public int tabIndex = 0;

    public void GoTo(int page)
    {
        tabIndex = page;
    }

    [CascadingParameter]
    private Session Session { get; set; }

    public void MigrateTags()
    {
        if (Session.State.User.GetId() != "190590364871032834")
        {
            ShowToast("You do not have access");
            return;
        }
        ShowToast("Running migration");
        foreach (GImage i in DB.Images.Values)
        {
            switch (i.album)
            {
                case 7:
                    {
                        try
                        {
                            i.tags.Add(10);
                        }
                        catch { }
                        i.Update();
                    }
                    break;
                case 1:
                    {
                        try
                        {
                            i.tags.Add(12);
                        }
                        catch { }
                        i.Update();
                    }
                    break;
                case 8:
                    {
                        try
                        {
                            i.tags.Add(9);
                        }
                        catch { }
                        try
                        {
                            i.tags.Add(1);
                        }
                        catch { }
                        i.Update();
                    }
                    break;
            }
        }
        ShowToast("Migrated tags data");
    }

    public void AddTag()
    {
        int id = DB.Tags.Values.OrderByDescending(x => x.id).First().id + 1;
        GTag newtag = new GTag()
            {
                id = id,
                name = NewTag
            };
        DB.Tags.Add(id, newtag);
        newtag.Add();
        ShowToast("Tag added", true);
    }

    void DeleteImage()
    {
        if (DB.Images.TryGetValue(Image, out GImage Img))
        {
            DB.Albums.TryGetValue(Img.album, out GAlbum album);
            if (Session.State.User.GetId() != "190590364871032834")
            {
                if (album == null)
                {
                    ShowToast("Image does not have an album");
                    return;
                }
                if (!(album.owner == Session.State.User.GetId() || album.access.ContainsKey(Session.State.User.GetId())))
                {
                    ShowToast("You do not have access to this image");
                    return;
                }
            }
            DB.R.Db(Program.DatabaseName).Table("Images").Get(Img.id).Delete().RunNoReply(DB.Con);

            if (File.Exists(Img.GetFile(imageType.Full)))
                File.Delete(Img.GetFile(imageType.Full));

            if (File.Exists(Img.GetFile(imageType.Medium)))
                File.Delete(Img.GetFile(imageType.Medium));

            if (DB.Images.Values.Where(x => x.file.hash == Img.file.hash).Count() == 1)
                DB.HashSet.Remove(Img.file.hash);
            DB.Images.Remove(Image);
            Image = "";
            ShowToast("Image deleted", true);
        }
    }

    void TestClick()
    {
        if (Session.State.User.GetId() != "190590364871032834")
        {
            ShowToast("You do not have access");
            return;
        }
        ShowToast("Thumbnails being regended");
        MagickReadSettings ReadSettings = new MagickReadSettings { ColorType = ColorType.Optimize, FrameCount = 1, FrameIndex = 0 };
        foreach (GImage i in DB.Images.Values)
        {
            if (File.Exists(i.GetFile(imageType.Medium)))
                continue;
            Console.WriteLine("REGEN: " + i.GetFile(imageType.Medium));
            using (FileStream fi = File.OpenRead(i.GetFile(imageType.Full)))
            {
                using (MagickImage image = new MagickImage(fi, ReadSettings))
                {
                    image.Resize(792, 594);
                    image.Write(i.GetFile(imageType.Medium), MagickFormat.WebP);
                    //image.Resize(320, 320);
                    //image.Write(i.GetFile(imageType.Thumbnail));
                }
            }
        }
        ShowToast("Thumbnails done!", true);
    }

    void CheckImages()
    {
        if (Session.State.User.GetId() != "190590364871032834")
        {
            ShowToast("You do not have access");
            return;
        }
        ShowToast("Checking images", true);
        foreach (GImage i in DB.Images.Values)
        {
            if (!File.Exists(i.GetFile(imageType.Full)))
            {
                ShowToast("Missing " + i.id, true);
            }
        }
        ShowToast("Checking done!", true);
    }

    public void ReloadAction(string type)
    {
        switch (type)
        {
            case "tags":
                DB.ReloadTags();
                break;
            case "albums":
                DB.ReloadAlbums();
                break;
            case "images":
                DB.ReloadImages();
                break;
            case "metadata":
                DB.ReloadMetaData();
                break;
            case "users":
                DB.ReloadUsers();
                break;
            case "api":
                DB.ReloadAPIKeys();
                break;
            case "waifu":
                DB.ReloadWaifuLewds();
                break;
        }
        ShowToast("Reloaded " + type);
    }

    public void ShowToast(string desc, bool force = false)
    {
        //Toaster.Add(desc, MatToastType.Success, "", "", config =>
        //{
        //    config.RequireInteraction = force;
        //    config.ShowCloseButton = force;
        //    config.ShowProgressBar = true;
        //    config.MaximumOpacity = Convert.ToInt32(100);

        //    config.ShowTransitionDuration = Convert.ToInt32(500);
        //    config.VisibleStateDuration = Convert.ToInt32(8000);
        //    config.HideTransitionDuration = Convert.ToInt32(500);
        //});
    }

}
